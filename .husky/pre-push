#!/bin/bash
# Prevents force-pushing to master
# Prompts to build before push

echo "                                    "
echo "ğŸ Pre-push Hook: Checking branch name..."
echo "------------------------------------"


COMMAND=$(grep "git push" ~/.zsh_history | tail -n 1 || grep "git push" ~/.bash_history | tail -n 1 || grep "git push" ~/.history | tail -n 1)
BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [[ "$BRANCH" == 'master' || "$COMMAND" == *"master"* ]]; then
  echo "ğŸš« Cannot push to remote master branch, create your own branch and use PR." 
  echo "------------------------------------" 
  echo "                                    " && exit 1
fi

if [[ "$BRANCH" == 'development' || "$COMMAND" == *"development"* ]]; then
  echo "ğŸš« Cannot push to remote development branch, create your own branch and use PR." 
  echo "------------------------------------" 
  echo "                                    " && exit 1
fi

echo "âœ… Finished checking branch name."
echo "                                    "
echo "************************************"


exec < /dev/tty
echo "                                    "
res=""
response1=""
while [[ ! "$response1" =~ ^[yn]$ ]]; do
    read -p "ğŸ¤¨ Build Storybook? (y/n): " response1
    echo "------------------------------------"
    if [[ ! "$response1" =~ ^[yn]$ ]]; then
        echo "ğŸš« Please enter 'y' or 'n'."
        echo "------------------------------------"
    fi
done

if [ "$response1" == "y" ]; then
    npm run build-storybook || git reset --hard HEAD
    res="y"
else
    echo "ğŸ¤Œ Skipped build-storybook."
    echo "------------------------------------"
fi

echo "                                    "
echo "************************************"
echo "                                    "
response2=""
while [[ ! "$response2" =~ ^[yn]$ ]]; do
    read -p "ğŸ¤¨ Build Storybook HUD? (y/n): " response2
    echo "------------------------------------"
    if [[ ! "$response2" =~ ^[yn]$ ]]; then
        echo "ğŸš« Please enter 'y' or 'n'."
        echo "------------------------------------"
    fi
done

if [ "$response2" == "y" ]; then
    npm run build-storybook-hud || git reset --hard HEAD
    res="y"
else
    echo "ğŸ¤Œ Skipped build-storybook-hud."
    echo "------------------------------------"
fi

if [[ "$res" == "y" ]]; then
    git add .
    git commit --amend --no-edit  --no-verify
    echo "âœ… Finish build check!"
    echo "                                    "
    echo "************************************"
else
    echo "âœ… Finish build check!"
    echo "                                    "
    echo "************************************" 
fi

# Continue with other pre-commit tasks or commands

exit 0
